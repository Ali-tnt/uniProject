{% extends 'core/base.html' %}

{% block title %}مکالمه{% endblock %}

{% block content %}
<meta http-equiv="refresh" content="5" >
<center><h1 class="mb-6 mx-0 text-4xl font-bold ">مکالمه</h1></center>

<div class="grid grid-cols-3 bg-slate-50 rounded-xl">
    <div class="col-span-1 mx-2">
        <form method="post" action="." class="mt-6">
            {% csrf_token %}

            {{ form.as_p }}

            <button class="signup py-2 px-8 xl:px-56 text-lg bg-blue-500 hover:bg-blue-700 rounded-xl text-white" type="submit">ارسال</button>
        </form>
    </div>
    <div class="col-span-2 mt-5 mx-2">
        <div id="chat" class="space-y-6" style="height:400px;overflow-y:auto;flex-direction: column-reverse;"> 
            TODO پیاما اسکرول شن پایین
            {% for message in conversation.messages.all %}
                <div class="p-6 flex {% if message.created_by == request.user %}bg-blue-100{% else %}bg-gray-200{% endif %} rounded-xl">
                    <div  >
                        <p class="mb-4">@{{ message.created_at }} | <strong>{{ message.created_by.username }}</strong></P>
                        <p>{{ message.content }}</P>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script type="text/javascript">
    // This script ensures that the chat is scrolled to the bottom on initial load.
    window.onload = function() {
        var chatBox = document.getElementById('chat');
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // This function will make an AJAX call to fetch new messages periodically,
    // it can be called on an interval or after a certain event.
    function updateChat() {
        // Assuming you have an endpoint "/fetch-messages/" that returns new messages in HTML format
        fetch('/fetch-messages/')
            .then(response => response.text())
            .then(html => {
                var chatBox = document.getElementById('chat');
                chatBox.innerHTML += html; // Append new messages
                
                // Scroll chat box to the bottom if the scrollbar is near the bottom
                // This prevents scrolling to the bottom when the user is reading previous messages.
                if (chatBox.scrollHeight - chatBox.scrollTop < 500) {
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
    }

    // You can call this function on an interval basis or after sending/receiving a message.
    setInterval(updateChat, 5000); // Fetches new messages every 5 seconds.
</script>
    
{% endblock content %}